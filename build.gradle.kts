plugins {
	id("eclipse")
	id("idea")
	id("maven-publish")
	id("net.minecraftforge.gradle").version("[6.0,6.2)")
	id("org.parchmentmc.librarian.forgegradle").version("1.+")
	id("org.spongepowered.mixin")
}

val minecraftVersion: String by extra
val minecraftVersionRange: String by extra
val loaderVersionRange: String by extra
val forgeVersionRange: String by extra
val modVersion: String by extra
val modGroupId: String by extra
val modId: String by extra
val modAuthors: String by extra
val modDescription: String by extra
val modLicense: String by extra
val modName: String by extra
val parchmentChannel: String by extra
val parchmentVersion: String by extra
val forgeVersion: String by extra
val jeiVersion: String by extra
val curiosVersion: String by extra
val mixinVersion: String by extra
val modJavaVersion: String by extra

version = modVersion
group = modGroupId

val baseArchivesName = "$modId-$minecraftVersion"
base {
	archivesName.set(baseArchivesName)
}

java {
	toolchain {
		languageVersion.set(JavaLanguageVersion.of(modJavaVersion))
	}
}

mixin {
	add(sourceSets.main.get(), "${modId}.refmap.json")
}

minecraft {
	mappings(parchmentChannel, parchmentVersion)

	copyIdeResources.set(true)

	accessTransformer(file("src/main/resources/META-INF/accesstransformer.cfg"))

	// Default run configurations.
	// These can be tweaked, removed, or duplicated as needed.
	runs {
		// applies to all the run configs below
		configureEach {
			workingDirectory(project.file("run"))

			property("forge.logging.markers", "REGISTRIES")
			property("forge.logging.console.level", "debug")

			mods {
				create("${modId}") {
					source(sourceSets.main.get())
				}
			}
		}

		create("client") {
			// Comma-separated list of namespaces to load gametests from. Empty = all namespaces.
			property("forge.enabledGameTestNamespaces", modId)
			arg("-mixin.config=" + modId + ".mixins.json")
		}

		create("server") {
			property("forge.enabledGameTestNamespaces", modId)
			args("--nogui")
			arg("-mixin.config=" + modId + ".mixins.json")
		}

		create("data") {
			// example of overriding the workingDirectory set in configureEach above
			workingDirectory(project.file("run-data"))

			// Specify the modid for data generation, where to output the resulting resource, and where to look for existing resources.
			args(
				"--mod",
				modId,
				"--all",
				"--output",
				file("src/generated/resources/"),
				"--existing",
				file("src/main/resources/")
			)
		}
	}
}

// Include resources generated by data generators.
sourceSets {
	main {
		resources.srcDir("src/generated/resources")
	}
}

repositories {
	mavenCentral()
	maven {
		name = "Curios maven"
		url = uri("https://maven.theillusivec4.top/")
	}
	maven {
		name = "JEI maven"
		url = uri("https://dvs1.progwml6.com/files/maven")
	}
	maven {
		name = "tterrag maven"
		url = uri("https://maven.tterrag.com/")
	}
	maven {
		name = "BlameJared maven"
		url = uri("https://maven.blamejared.com/")
	}
	maven {
		name = "Curse Maven"
		url = uri("https://cursemaven.com")
		content {
			includeGroup("curse.maven")
		}
	}
}

dependencies {
	minecraft("net.minecraftforge:forge:${minecraftVersion}-${forgeVersion}")

	if (System.getProperty("idea.sync.active") != "true") {
		annotationProcessor("org.spongepowered:mixin:${mixinVersion}:processor")
	}

	// JEI Dependency
	compileOnly(fg.deobf("mezz.jei:jei-${minecraftVersion}-forge-api:${jeiVersion}"))
	compileOnly(fg.deobf("mezz.jei:jei-${minecraftVersion}-common-api:${jeiVersion}"))
	runtimeOnly(fg.deobf("mezz.jei:jei-${minecraftVersion}-forge:${jeiVersion}"))

	// Curios dependency
	compileOnly(fg.deobf("top.theillusivec4.curios:curios-forge:${curiosVersion}:api"))
	runtimeOnly(fg.deobf("top.theillusivec4.curios:curios-forge:${curiosVersion}"))

	implementation(fg.deobf("curse.maven:farmers_delight-398521:4638874"))
}

tasks.withType<ProcessResources> {
	inputs.property("version", version)

	filesMatching(listOf("META-INF/mods.toml", "pack.mcmeta")) {
		expand(
			mapOf(
				"forgeVersionRange" to forgeVersionRange,
				"loaderVersionRange" to loaderVersionRange,
				"minecraftVersion" to minecraftVersion,
				"minecraftVersionRange" to minecraftVersionRange,
				"modAuthor" to modAuthors,
				"modDescription" to modDescription,
				"modId" to modId,
				"modJavaVersion" to modJavaVersion,
				"modName" to modName,
				"version" to version,
			)
		)
	}
}

tasks.withType<Jar> {
//	val now = java.text.SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssZ").format(java.util.Date())
	manifest {
		attributes(mapOf(
			"Specification-Title" to modName,
			"Specification-Vendor" to modAuthors,
			"Specification-Version" to '1',
			"Implementation-Title" to modName,
			"Implementation-Version" to modVersion,
			"Implementation-Vendor" to modAuthors,
//			"Implementation-Timestamp" to now,
		))
	}
	finalizedBy("reobfJar")
}

publishing {
	publications {
		register<MavenPublication>("mavenJava") {
			artifactId = baseArchivesName
			artifact(tasks.jar.get())
		}
	}
	repositories {
		val mavenDir = System.getenv("local_maven")
		if (mavenDir != null) {
			maven(mavenDir)
		}
	}
}

idea {
	module {
		for (fileName in listOf("run", "out", "logs")) {
			excludeDirs.add(file(fileName))
		}
	}
}

tasks.withType<JavaCompile> {
	options.encoding = "UTF-8"
}
